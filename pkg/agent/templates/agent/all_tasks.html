{%extends "agent/agent_dashboard.html"%}
{%block content%}
<div class="container-fluid mt-4">

    <!-- HEADER -->
    <div class="page-header mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1">
                <i class="fas fa-truck-loading text-primary mr-2"></i>
                My Assigned Tasks
            </h4>
            <small class="text-muted">
                <i class="far fa-calendar-alt mr-1"></i>
                {{ today.strftime('%A, %b %d, %Y') }}
            </small>
        </div>

        <div class="text-right">
            <div class="font-weight-bold">{{ agent.full_name }}</div>
            <small class="text-muted">Agent Dashboard</small>
        </div>
    </div>

    <!-- TASKS TABLE -->
    <div class="card shadow-sm">
        <div class="card-body">

            <table class="table table-custom table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th style="width: 12%;">Tracking ID</th>
                        <th style="width: 20%;">Pickup Location</th>
                        <th style="width: 20%;">Destination</th>
                        <th style="width: 15%;">Assigned Date</th>
                        <th style="width: 15%;">Current Status</th>
                        <th style="width: 18%;">Actions</th>
                    </tr>
                </thead>
                <tbody>

                {% for s in shipments %}
                    <tr>
                        <td class="font-weight-bold text-primary">
                            #{{ s.tracking_number }}
                        </td>

                        <td>
                            <i class="fas fa-map-pin text-warning mr-1"></i>
                            {{ s.pickup_city }}, {{ s.pickup_state }}
                        </td>

                        <td>
                            <i class="fas fa-route text-primary mr-1"></i>
                            {{ s.delivery_city }}, {{ s.delivery_state }}
                        </td>

                        <td>
                            <small class="text-muted">
                                {{ s.assignment_date.strftime('%b %d, %Y') if s.assignment_date else 'N/A' }}
                            </small>
                        </td>

                        <td>
                            {% set status_lower = s.status|lower|replace(' ', '_') %}

                            {% if status_lower in ['assigned', 'awaiting_pickup'] %}
                                <span class="badge badge-warning px-3 py-2 rounded-pill text-dark">
                                    Awaiting Pickup
                                </span>
                            {% elif status_lower in ['picked_up', 'in_transit'] %}
                                <span class="badge badge-info px-3 py-2 rounded-pill text-white">
                                    In Transit
                                </span>
                            {% elif status_lower == 'delivered' %}
                                <span class="badge badge-success px-3 py-2 rounded-pill">
                                    Delivered
                                </span>
                            {% else %}
                                <span class="badge badge-secondary px-3 py-2 rounded-pill">
                                    {{ s.status|capitalize }}
                                </span>
                            {% endif %}
                        </td>

                        <td>
                            <div class="d-flex flex-column align-items-center">

                                <a href="{{ url_for('bpshipment.public_shipment_tracking', tracking_number=s.tracking_number) }}"
                                   class="btn btn-sm btn-outline-primary mb-2 w-100"
                                   target="_blank">
                                    <i class="fas fa-info-circle mr-1"></i> Details
                                </a>

                                <form method="POST"
                                      action="{{ url_for('bpagent.update_shipment_status', shipment_id=s.id) }}"
                                      class="w-100">

                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                    {% if status_lower in ['assigned', 'awaiting_pickup'] %}
                                        <input type="hidden" name="new_status" value="Picked Up">
                                        <button type="submit"
                                                class="btn btn-sm btn-warning w-100 font-weight-bold"
                                                onclick="return confirm('Confirm marking #{{ s.tracking_number }} as Picked Up?');">
                                            <i class="fas fa-dolly mr-1"></i> Pick Up
                                        </button>

                                    {% elif status_lower in ['picked_up', 'in_transit'] %}
                                        <input type="hidden" name="new_status" value="Delivered">
                                        <button type="submit"
                                                class="btn btn-sm btn-success w-100 font-weight-bold"
                                                onclick="return confirm('Confirm marking #{{ s.tracking_number }} as Delivered?');">
                                            <i class="fas fa-check-double mr-1"></i> Deliver
                                        </button>

                                    {% else %}
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary w-100"
                                                disabled>
                                            Completed
                                        </button>
                                    {% endif %}
                                </form>
                            </div>
                        </td>
                    </tr>

                {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>
                            You currently have no shipments assigned.
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>

        </div>
    </div>

</div>

{% endblock %}
